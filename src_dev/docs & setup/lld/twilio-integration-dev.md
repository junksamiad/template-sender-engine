# Twilio Integration - WhatsApp Channel Processor - LLD (Dev)

## 1. Introduction

This document provides the low-level design for the Twilio API integration within the `whatsapp-channel-processor-dev` Lambda function. This integration is responsible for sending the initial outgoing WhatsApp message to the end-user via a pre-approved Twilio Content Template, using dynamically generated variables from the OpenAI service.

## 2. Purpose & Interaction Flow

*   **Purpose:** To reliably send templated WhatsApp messages using credentials stored securely and content variables generated by the AI.
*   **Interaction Flow (within `index.lambda_handler`):**
    1.  **Step 5:** The Lambda fetches Twilio credentials (Account SID, Auth Token, Template SID) from AWS Secrets Manager using a reference stored in the `context_object`. The fetched credentials are stored in the `channel_credentials` dictionary.
    2.  **Step 6:** The Lambda interacts with the OpenAI service, receiving structured `content_variables` and the `thread_id` in the `openai_result` dictionary.
    3.  **Step 7:**
        *   The Lambda extracts the recipient phone number (`recipient_tel`) from the `context_object` (`frontend_payload.recipient_data`).
        *   The Lambda extracts the Twilio sender number (`twilio_sender_number`) from the `context_object` (`company_data_payload.channel_config.whatsapp.company_whatsapp_number`).
        *   The Lambda extracts the `content_variables` dictionary from `openai_result`.
        *   The Lambda calls the `send_whatsapp_template_message` function located in `services/twilio_service.py`, passing the `channel_credentials` dictionary (as `twilio_config`), `recipient_tel`, `twilio_sender_number`, and `content_variables`.
        *   The function returns a dictionary containing the Twilio Message SID and the rendered message body (`twilio_result`) or `None` if an error occurs.
        *   The Lambda handles the result, logging success/failure and raising an error if the call failed to prevent SQS message deletion.
    4.  **Step 8:** The returned Twilio Message SID and message body are used to update the conversation record in DynamoDB.

## 3. Component Details

### 3.1. Service Module (`services/twilio_service.py`)

*   **Function:** `send_whatsapp_template_message(twilio_config, recipient_tel, twilio_sender_number, content_variables)`
*   **Arguments:**
    *   `twilio_config` (Dict): Contains credentials fetched from Secrets Manager. Expected keys: `twilio_account_sid`, `twilio_auth_token`, `twilio_template_sid`.
    *   `recipient_tel` (str): The E.164 formatted recipient phone number (e.g., `+44...`).
    *   `twilio_sender_number` (str): The E.164 formatted Twilio sender phone number (e.g., `+1...`).
    *   `content_variables` (Dict): The dictionary of template variables produced by OpenAI.
*   **Core Logic:**
    1.  Extracts Account SID, Auth Token, and Template SID (used as `content_sid`) from `twilio_config`.
    2.  Validates the presence of required config values, recipient number, and sender number.
    3.  Formats sender and recipient numbers by prepending `whatsapp:`.
    4.  Serializes the `content_variables` dictionary into a JSON string using `json.dumps()`.
    5.  Initializes the `twilio.rest.Client` with the Account SID and Auth Token.
    6.  Calls `client.messages.create()` using:
        *   `from_`: Formatted sender number.
        *   `to`: Formatted recipient number.
        *   `content_sid`: The Template SID extracted from `twilio_config`.
        *   `content_variables`: The JSON string created in step 4.
    7.  Logs success, including the Message SID and rendered body returned by the API.
    8.  Handles `TwilioRestException` and general `Exception`, logging detailed error information.
*   **Return Value:**
    *   On Success: `Dict` containing `{"message_sid": "SM...", "body": "Rendered message..."}`.
    *   On Failure: `None`.

### 3.2. Lambda Handler (`index.py` - Step 7)

*   Responsible for orchestrating the call to `send_whatsapp_template_message`.
*   Sources the arguments:
    *   `twilio_config`: From `channel_credentials` dictionary (populated in Step 5).
    *   `recipient_tel`: From `context_object['frontend_payload']['recipient_data']['recipient_tel']`.
    *   `twilio_sender_number`: From `context_object['company_data_payload']['channel_config']['whatsapp']['company_whatsapp_number']`.
    *   `content_variables`: From `openai_result['content_variables']` (result of Step 6).
*   Handles the dictionary returned by the service function or `None` in case of failure.

### 3.3. AWS Secrets Manager

*   Stores the Twilio credentials (Account SID, Auth Token, Template SID).
*   The secret name is referenced in `context_object['company_data_payload']['channel_config']['whatsapp']['whatsapp_credentials_id']`.
*   Expected JSON structure within the secret:
    ```json
    {"twilio_account_sid": "AC...", "twilio_auth_token": "...", "twilio_template_sid": "HX..."}
    ```
*   **Reference:** `src_dev/docs & setup/lld/aws-secrets-manager-dev.md`

### 3.4. DynamoDB (`company-data-dev`)

*   The `channel_config.whatsapp` map within the company/project record stores the reference (`whatsapp_credentials_id`) to the secret in Secrets Manager and the `company_whatsapp_number` used for sending.

## 4. Error Handling

*   The `send_whatsapp_template_message` function catches `TwilioRestException` and logs specific details (status code, Twilio error code, message).
*   It also catches generic `Exception` for other potential failures during the API call.
*   If the function returns `None`, the calling code in `index.py` logs an error and raises a `RuntimeError`. This ensures the SQS message processing fails, leading to retries and eventual DLQ placement if the error persists.
*   Common Twilio errors to anticipate:
    *   Authentication failure (invalid SID/Token).
    *   Invalid recipient number format or number not enabled for WhatsApp.
    *   Invalid Template SID (`content_sid`).
    *   Mismatched `content_variables` keys/structure compared to the template placeholders.
    *   Throttling / Rate limits. 