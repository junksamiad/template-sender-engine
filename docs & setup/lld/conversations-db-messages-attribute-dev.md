# DynamoDB `conversations-dev` Table - `messages` Attribute LLD

## 1. Introduction

This document details the structure and usage of the `messages` attribute within the `conversations-dev` DynamoDB table. This attribute stores the history of a conversation as a chronological list of interactions.

## 2. Attribute Type

The `messages` attribute is a DynamoDB **List (`L`)**. 

## 3. List Item Structure

Each element appended to the `messages` list is a DynamoDB **Map (`M`)** representing a single message turn. The structure of this Map depends on the role (sender) of the message.

### 3.1. Assistant Message Object (`role: "assistant"`)

This structure is used when the system (via an AI assistant and channel provider like Twilio) sends a message to the user. This is the type added by the initial Channel Processor (e.g., `whatsapp-channel-processor-dev`).

```json
{
  "message_id": { "S": "SMxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" }, // Typically the Channel Provider's Message SID (e.g., Twilio SID)
  "timestamp": { "S": "2023-10-26T12:00:00.123Z" }, // ISO 8601 UTC timestamp of when the message was processed/sent
  "role": { "S": "assistant" },
  "content": { "S": "Hello Lee, this is Carol..." }, // The actual message content sent to the user
  "prompt_tokens": { "N": "123" }, // Tokens used by AI for the prompt/context
  "completion_tokens": { "N": "45" }, // Tokens generated by AI for the response
  "total_tokens": { "N": "168" } // Total tokens for the AI interaction generating this message
}
```

**Key Fields:**
*   `message_id` (String): Unique identifier for this specific message delivery (e.g., Twilio SID).
*   `timestamp` (String): ISO 8601 UTC timestamp.
*   `role` (String): Always "assistant".
*   `content` (String): The final message text sent to the end-user.
*   `prompt_tokens` (Number): OpenAI prompt token count.
*   `completion_tokens` (Number): OpenAI completion token count.
*   `total_tokens` (Number): OpenAI total token count for this turn.

### 3.2. User Message Object (`role: "user"`)

This structure will be used by future processes (e.g., an incoming webhook handler) when a user sends a reply message.

```json
{
  "message_id": { "S": "SMxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" }, // Typically the Channel Provider's Message SID (e.g., Twilio SID of the incoming message)
  "timestamp": { "S": "2023-10-26T12:05:00.456Z" }, // ISO 8601 UTC timestamp of when the message was received
  "role": { "S": "user" },
  "content": { "S": "Yes, that sounds good." } // The actual message content received from the user
  // AI Token fields (prompt_tokens, completion_tokens, total_tokens) would likely be NULL or omitted for user messages.
}
```

**Key Fields:**
*   `message_id` (String): Unique identifier for this specific incoming message (e.g., Twilio SID).
*   `timestamp` (String): ISO 8601 UTC timestamp.
*   `role` (String): Always "user".
*   `content` (String): The message text received from the end-user.

## 4. Updating the List

New message objects are appended to the end of the `messages` list using the DynamoDB `UpdateItem` operation with an `UpdateExpression` that utilizes the `list_append` function.

**Example UpdateExpression Fragment:**

`SET messages = list_append(if_not_exists(messages, :empty_list), :new_message)`

*   `:new_message`: A list containing the single new message Map object (e.g., `[{ "M": { ... new message object ... } }]`).
*   `:empty_list`: An empty list (`[]`), used by `if_not_exists` to initialize the `messages` attribute if it doesn't exist on the record yet.

This ensures that messages are added chronologically to the list attribute. 