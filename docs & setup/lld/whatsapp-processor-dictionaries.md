# WhatsApp Channel Processor Lambda - Key Dictionaries

This document outlines the main dictionary (dict) objects created, passed, and manipulated within the `whatsapp-channel-processor-dev` Lambda function (`index.py`). Understanding these structures is crucial for following the data flow through the processor.

1.  **`event` (Input)**
    *   **Source:** AWS SQS Trigger
    *   **Purpose:** The standard event object passed by AWS when SQS triggers the Lambda. Contains metadata about the invocation and a list of SQS message records.
    *   **Key Structure:** `{ "Records": [ record_1, record_2, ... ] }`

2.  **`record` (Loop Variable)**
    *   **Source:** Iteration over `event['Records']` list.
    *   **Purpose:** Represents a single SQS message record being processed in the current loop iteration.
    *   **Key Structure:** Contains keys like `messageId`, `receiptHandle`, `body` (JSON string), `attributes`, etc.

3.  **`context_object` (Core Data)**
    *   **Source:** Deserialized JSON string from `record['body']`. Originally created by the `channel-router-dev` Lambda.
    *   **Purpose:** The central data structure carrying all necessary information for processing the request. It's validated upon receipt.
    *   **Key Structure (High-Level):**
        ```python
        {
          "metadata": { ... },
          "frontend_payload": {
            "company_data": { ... },
            "recipient_data": { "recipient_tel": "...", ... },
            "request_data": { "request_id": "...", ... },
            "project_data": { ... } # Optional
          },
          "company_data_payload": { # Config from company-data-dev DB
            "company_id": "...",
            "project_id": "...",
            "allowed_channels": [ ... ],
            "project_status": "...",
            "channel_config": {
              "whatsapp": {
                "whatsapp_credentials_id": "secret-arn-or-name",
                "company_whatsapp_number": "whatsapp:+1..."
                # ... other whatsapp config
              },
              # ... other channels
            },
            "ai_config": {
                "openai_config": {
                    "whatsapp": { # Channel-specific AI config
                        "api_key_reference": "secret-arn-or-name",
                        "assistant_id_template_sender": "asst_...",
                         # ... other AI config for this channel
                    }
                    # ... other channels
                }
            },
            # ... other company/project config
          },
          "conversation_data": {
            "conversation_id": "...", # Generated by router
            # ... initial placeholders generated by router
          }
        }
        ```

4.  **`openai_credentials` (Fetched Secret)**
    *   **Source:** Returned by `services.secrets_manager_service.get_secret()` using the reference from `context_object['company_data_payload']['ai_config']['openai_config'][channel_method]['api_key_reference']`.
    *   **Purpose:** Holds the sensitive credentials needed to authenticate with the OpenAI API.
    *   **Structure:** Depends on how the secret is stored (e.g., `{"api_key": "sk-..."}` or just the key string itself). The `process_message_with_ai` service expects the API key.

5.  **`channel_credentials` (Fetched Secret)**
    *   **Source:** Returned by `services.secrets_manager_service.get_secret()` using the reference from `context_object['company_data_payload']['channel_config'][channel_method][f'{channel_method}_credentials_id']`.
    *   **Purpose:** Holds the sensitive credentials needed for the specific channel provider (e.g., Twilio Account SID, Auth Token, potentially Template SID for WhatsApp).
    *   **Structure:** Depends on secret storage (e.g., `{"account_sid": "AC...", "auth_token": "...", "template_sid": "HX..."}`). The `send_whatsapp_template_message` service expects this structure.

6.  **`conversation_details` (Constructed for AI Service)**
    *   **Source:** Built within the `lambda_handler` before calling the OpenAI service.
    *   **Purpose:** Packages specific pieces of information needed by the `process_message_with_ai` function.
    *   **Key Structure:**
        ```python
        {
          "conversation_id": "...", # From context_object
          "thread_id": None,        # Explicitly None for initial call
          "assistant_id": "asst_...", # From context_object (template sender specific)
          "project_data": { ... },  # From context_object
          "recipient_data": { ... },# From context_object
          "company_name": "...",    # From context_object
          "project_name": "...",    # From context_object
          "company_rep": { ... },   # From context_object
          "ai_channel_config": { ... }, # Specific channel's AI config from context_object
          "all_channel_contact_info": { # Built within handler
              "whatsapp": "whatsapp:+1...",
              "email": "...",
              # ... etc for configured channels
          }
        }
        ```

7.  **`built_contact_info` (Intermediate)**
    *   **Source:** Constructed within the `lambda_handler` by iterating over `context_object['company_data_payload']['channel_config']`.
    *   **Purpose:** Temporary dictionary holding extracted company contact points (e.g., WhatsApp number, email address) before being assigned to `conversation_details['all_channel_contact_info']`.
    *   **Structure:** `{ "whatsapp": "...", "email": "..." }`

8.  **`openai_result` (Service Output)**
    *   **Source:** Returned by `services.openai_service.process_message_with_ai()`.
    *   **Purpose:** Contains the results of the AI processing step.
    *   **Key Structure:**
        ```python
        {
          "content_variables": { ... }, # Variables extracted/generated by AI for templates
          "thread_id": "thread_...",    # The OpenAI thread ID used/created
          "prompt_tokens": ...,       # Token usage info
          "completion_tokens": ...,   # Token usage info
          "total_tokens": ...         # Token usage info
        }
        ```

9.  **`content_variables_dict` (Extracted)**
    *   **Source:** Extracted directly from `openai_result['content_variables']`.
    *   **Purpose:** Holds the template variables needed by the Twilio service.
    *   **Structure:** Variable key-value pairs defined by the OpenAI Assistant's output.

10. **`twilio_result` (Service Output)**
    *   **Source:** Returned by `services.twilio_service.send_whatsapp_template_message()`.
    *   **Purpose:** Contains the outcome of the Twilio API call.
    *   **Key Structure:** `{"message_sid": "SM...", "body": "Sent message content..."}` (or `None` on failure).

11. **`new_message_object` (Constructed for DB)**
    *   **Source:** Built within the `lambda_handler` after successful Twilio send.
    *   **Purpose:** Represents the structured message data to be appended to the `messages` list attribute in the `conversations-dev` DynamoDB table.
    *   **Key Structure:**
        ```python
        {
          "message_id": "SM...", # Twilio SID
          "timestamp": "isoformat-string",
          "role": "assistant",
          "content": "Sent message content...", # From Twilio result
          "prompt_tokens": ..., # From OpenAI result
          "completion_tokens": ..., # From OpenAI result
          "total_tokens": ... # From OpenAI result
        }
        ```

12. **`response` (Output)**
    *   **Source:** Constructed at the end of the `lambda_handler`.
    *   **Purpose:** The standard return format for Lambda functions processing SQS events with potential partial batch failures.
    *   **Key Structure:** `{ "batchItemFailures": [ { "itemIdentifier": "failed_message_id_1" }, ... ] }` (List is empty on full success). 