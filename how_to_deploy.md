# How to Deploy the AI Multi-Comms Engine (Using AWS SAM)

This document outlines the process for deploying the AI Multi-Comms Engine to either the `dev` or `prod` AWS environment using the AWS Serverless Application Model (SAM) CLI.

## 1. Prerequisites

*   **AWS CLI:** Installed and configured with appropriate credentials for the target AWS account.
*   **AWS SAM CLI:** Installed (`sam --version`).
*   **Docker:** Installed and **running**. The build process uses Docker containers.
*   **Git:** Project checked out, and you are on the correct branch (`develop` for deploying to `dev`, `main` for deploying to `prod`).
*   **Project Root:** All commands should be run from the root directory of the `template-sender-engine` project.

## 2. Infrastructure Definition

*   All AWS resources (Lambdas, API Gateway, DynamoDB Tables, SQS Queues, IAM Roles, etc.) are defined in the `template.yaml` file in the project root.
*   The template is parameterized using a `Parameters:` section, most importantly `EnvironmentName` (default: `dev`) which controls resource naming suffixes and other environment-specific settings.

## 3. Build Process (Containerized)

Before deploying, especially if code or dependencies (`requirements.txt`) have changed, build the application artifacts using a Docker container. This ensures dependencies are packaged correctly for the Lambda environment.

*   **Command:**
    ```bash
    sam build --use-container
    ```
*   **Purpose:** Reads `template.yaml`, finds the Lambda function definitions (`CodeUri`), installs dependencies from the respective `requirements.txt` files inside a Docker container matching the Lambda runtime, and packages the code.
*   **Output:** Creates deployment artifacts in the `.aws-sam/build/` directory, including zipped code packages and a processed `template.yaml`.
*   **Why Container:** We encountered issues (`Errno 35 Resource deadlock avoided`) when building locally without `--use-container`, likely due to Docker file sharing interactions with the project directory residing in iCloud Drive. Using `--use-container` resolves this and provides a more consistent build environment matching AWS Lambda.

## 4. Deployment Process (SAM Deploy)

Deployment uses the `sam deploy` command, which interacts with AWS CloudFormation to create or update the stack defined in the template.

*   **Command Structure:**
    ```bash
    sam deploy \
        --template-file .aws-sam/build/template.yaml \
        --stack-name <stack-name> \
        --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM \
        --resolve-s3 \
        --parameter-overrides <parameter-key>=<value> ...
    ```
*   **Key Flags Explained:**
    *   `--template-file .aws-sam/build/template.yaml`: **Crucial.** Tells deploy to use the template generated by the `sam build` step.
    *   `--stack-name`: The name of the CloudFormation stack to create or update (e.g., `ai-multi-comms-dev`, `ai-multi-comms-prod`).
    *   `--capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM`: Required acknowledgment that the template will create/modify IAM resources with specific names.
    *   `--resolve-s3`: Automatically packages and uploads code artifacts found by `sam build` to the SAM-managed S3 deployment bucket.
    *   `--parameter-overrides`: **Essential for environment targeting.** Sets the values for parameters defined in `template.yaml`. Must include `EnvironmentName=dev` or `EnvironmentName=prod` and potentially others like `LogLevel`.

## 5. Deploying Specific Environments

### 5.1 Deploying to DEV

*   **Source Branch:** Ensure you are on the `develop` branch (`git checkout develop && git pull origin develop`).
*   **Build:** `sam build --use-container`
*   **Deploy Command:**
    ```bash
    sam deploy \
        --template-file .aws-sam/build/template.yaml \
        --stack-name ai-multi-comms-dev \
        --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM \
        --resolve-s3 \
        --parameter-overrides EnvironmentName=dev LogLevel=DEBUG # Use DEBUG for dev
    ```

### 5.2 Deploying to PROD

*   **Source Branch:** Ensure you are on the `main` branch (`git checkout main && git pull origin main`). **Ensure `main` has been updated by merging a tested `develop` branch.**
*   **Build:** `sam build --use-container`
*   **Deploy Command:**
    ```bash
    sam deploy \
        --template-file .aws-sam/build/template.yaml \
        --stack-name ai-multi-comms-prod \
        --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM \
        --resolve-s3 \
        --parameter-overrides EnvironmentName=prod LogLevel=INFO # Use INFO for prod
    ```

## 6. Post-Deployment Steps (Manual for now)

Remember that certain configurations are managed outside the SAM template currently:

*   **API Keys & Usage Plan Association:** Need to be created/managed via Console/CLI and associated with the correct Usage Plan and API Stage.
*   **Secrets:** Secrets in AWS Secrets Manager need to be created and populated with the correct credentials for each environment (`...-dev`, `...-prod`).
*   **DynamoDB Data:** Initial configuration data needs to be added to the `company-data-${EnvironmentName}` table.
*   **SNS Subscriptions:** Endpoints need to be subscribed (and confirmed) to the relevant `critical-alerts-${EnvironmentName}` topic. 